zerops:
  - setup: api
    build:
      os: ubuntu
      base: rust@latest
      prepareCommands:
        # TODO: Change after Zerops Rust images are fixed.
        - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
      buildCommands:
        - ~/.cargo/bin/cargo build -p sheeet-api -r
        - mv target/release/sheeet-api sheeet-api
      deployFiles:
        - sheeet-api
      cache:
        - target
    run:
      os: ubuntu
      base: rust@latest
      prepareCommands:
        # TODO: Change after Zerops Rust images are fixed.
        - sudo apt-get update && sudo apt-get install -y build-essential
        - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        - ~/.cargo/bin/rustup target add wasm32-unknown-unknown
        - curl -sL https://github.com/trunk-rs/trunk/releases/download/v0.21.14/trunk-x86_64-unknown-linux-musl.tar.gz | tar -xzf -
        - mv trunk ~/.cargo/bin/trunk
      ports:
        - port: 8080
          httpSupport: true
      envVariables:
        RUST_LOG: debug
        WORKSPACES_PATH: /var/www/workspaces
      initCommands:
        - mkdir -p /var/www/workspaces
      start: ./sheeet-api
          
  - setup: app
    build: 
      os: ubuntu
      base: rust@latest
      prepareCommands:
        # TODO: Change after Zerops Rust images are fixed.
        - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        - ~/.cargo/bin/rustup target add wasm32-unknown-unknown
        - curl -sL https://github.com/trunk-rs/trunk/releases/download/v0.21.14/trunk-x86_64-unknown-linux-musl.tar.gz | tar -xzf -
        - mv trunk ~/.cargo/bin/trunk
      buildCommands:
        - cd wasm; ~/.cargo/bin/trunk build
      deployFiles: 
        - wasm/dist
      cache:
        - target
    run: 
      os: ubuntu
      base: static@latest
      envVariables:
        API_URL: $api_zeropsSubdomain
      envReplace:
        delimiter: '$$'
        target: wasm/dist
      routing:
        root: wasm/dist
        