zerops:
  - setup: api
    build:
      os: ubuntu
      base: rust@stable
      buildCommands:
        - zsc scale cpu 8 10m
        - cargo build --package sheeet-api --release --jobs 8
        - mv target/release/sheeet-api sheeet-api
      deployFiles:
        - sheeet-api
      cache:
        - target
    run:
      os: ubuntu
      base: rust@stable
      prepareCommands:
        - rustup target add wasm32-unknown-unknown
        - curl -L --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | bash
        - cargo binstall -y trunk
      ports:
        - port: 8080
          httpSupport: true
      envVariables:
        RUST_LOG: debug
        SHEEET_WORKSPACES_PATH: /var/www/workspaces
      initCommands:
        - mkdir -p /var/www/workspaces
      start: ./sheeet-api
          
  - setup: app
    build: 
      os: alpine
      base: rust@stable
      prepareCommands:
        - rustup target add wasm32-unknown-unknown
        - curl -L --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | bash
        - cargo binstall -y trunk
      buildCommands:
        - zsc scale cpu 8 10m
        - cd wasm; trunk build
      deployFiles: 
        - wasm/dist
      cache:
        - target
    run: 
      os: alpine
      base: static@latest
      envVariables:
        API_URL: ${api_zeropsSubdomain}/api
      envReplace:
        delimiter: '$$'
        target: wasm/dist
      routing:
        root: wasm/dist

  - setup: demo
    extends: app
    run:
      envVariables:
        API_URL: https://sheeet.matejpavlicek.cz/api